name: Sync Prebuilt From Release

on:
  workflow_dispatch:
    inputs:
      release_owner:
        description: 发布仓库 owner
        required: true
        default: wqfc09
      release_repo:
        description: 发布仓库 repo
        required: true
        default: ffmpeg-kit
      release_tag:
        description: 发布标签
        required: true
        default: test
      android_asset:
        description: Android 资产文件名
        required: true
        default: ffmpegkit-android-aar.zip
      ios_asset:
        description: iOS 资产文件名
        required: true
        default: ffmpegkit-ios-xcframework.zip

jobs:
  sync-prebuilt:
    name: Download and Prepare Prebuilt
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Plugin Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Prepare Android AAR
        env:
          FFMPEG_KIT_RELEASE_OWNER: ${{ github.event.inputs.release_owner }}
          FFMPEG_KIT_RELEASE_REPO: ${{ github.event.inputs.release_repo }}
          FFMPEG_KIT_RELEASE_TAG: ${{ github.event.inputs.release_tag }}
          FFMPEG_KIT_ANDROID_ASSET: ${{ github.event.inputs.android_asset }}
        run: |
          chmod +x scripts/setup_android.sh
          ./scripts/setup_android.sh

      - name: Prepare iOS XCFramework
        env:
          FFMPEG_KIT_RELEASE_OWNER: ${{ github.event.inputs.release_owner }}
          FFMPEG_KIT_RELEASE_REPO: ${{ github.event.inputs.release_repo }}
          FFMPEG_KIT_RELEASE_TAG: ${{ github.event.inputs.release_tag }}
          FFMPEG_KIT_IOS_ASSET: ${{ github.event.inputs.ios_asset }}
        run: |
          chmod +x scripts/setup_ios.sh
          ./scripts/setup_ios.sh

      - name: Verify Outputs
        run: |
          test -f android/libs/ffmpeg-kit-custom.aar
          find ios/Frameworks -type d -name "*.xcframework" | head -n 50

      - name: Archive Prepared Files
        run: |
          mkdir -p artifacts
          cp -R android/libs artifacts/android-libs
          cp -R ios/Frameworks artifacts/ios-frameworks
          tar -czf ffmpeg-kit-prebuilt-prepared.tar.gz artifacts

      - name: Upload Prepared Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-kit-prebuilt-prepared
          if-no-files-found: error
          path: |
            ffmpeg-kit-prebuilt-prepared.tar.gz
