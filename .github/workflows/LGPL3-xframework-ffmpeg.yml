name: Build Custom FFmpeg iOS

permissions:
  contents: write

on:
  workflow_dispatch:
  workflow_call:

jobs:
  build-ios:
    name: Build iOS XCFramework
    runs-on: macos-14

    steps:
      - name: Checkout FFmpeg Kit Fork
        uses: actions/checkout@v4
        with:
          repository: arthenica/ffmpeg-kit
          ref: main
          fetch-depth: 1

      - name: Show Xcode Version
        run: |
          xcodebuild -version
          xcode-select -p

      - name: Install Build Dependencies
        run: |
          brew update
          brew install autoconf automake libtool pkg-config cmake nasm yasm meson ninja

      - name: Build with Custom Flags
        env:
          FFMPEG_KIT_FFMPEG_CONFIGURE_FLAGS: >-
            --enable-version3 --disable-gpl --disable-nonfree
            --disable-all
            --enable-ffmpeg --enable-ffprobe
            --enable-avcodec --enable-avformat --enable-avfilter --enable-avdevice --enable-avutil --enable-swresample --enable-swscale
            --enable-videotoolbox
            --enable-protocol=file,pipe,http,tcp,udp
            --enable-demuxer=mov,mp4,m4a,matroska,avi,webp,image2,h264,hevc,aac,mp3
            --enable-muxer=mp4,mov,image2,webp,null
            --enable-parser=h264,hevc,aac,mpegaudio
            --enable-decoder=h264_videotoolbox,hevc_videotoolbox,vp9_videotoolbox,av1_videotoolbox,h264,hevc,vp9,av1,libdav1d,aac,mp3,webp,mjpeg,png
            --enable-encoder=h264_videotoolbox,hevc_videotoolbox,aac,libwebp,libwebp_anim
            --enable-filter=split,scale,format,null,fps,crop,transpose
            --enable-libwebp
            --enable-libdav1d
        run: |
          chmod +x ios.sh
          ./ios.sh -x --disable-armv7 --disable-i386 --enable-dav1d | tee build.log

      - name: Check Build Outputs
        run: |
          echo "=== XCFramework Files ==="
          find . -type d -name "*.xcframework" | head -n 200
          echo "=== WebP/DAV1D/VideoToolbox Signals in Log ==="
          grep -Ei "libwebp|webp|dav1d|libdav1d|videotoolbox" build.log | tail -n 80 || true

      - name: Pack XCFramework Artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts/ios-xcframework

          # macOS 默认 /bin/bash 为 3.2，不支持 mapfile，这里改为兼容写法
          XCF_LIST_FILE="$(mktemp)"
          find prebuilt -type d -name "*.xcframework" > "$XCF_LIST_FILE" || true
          if [ ! -s "$XCF_LIST_FILE" ]; then
            # 部分 fork 的输出目录不在 prebuilt，下探到工作目录兜底
            find . -type d -name "*.xcframework" > "$XCF_LIST_FILE" || true
          fi

          if [ ! -s "$XCF_LIST_FILE" ]; then
            echo "No xcframework output found in workspace."
            exit 1
          fi

          while IFS= read -r xcf; do
            cp -R "$xcf" artifacts/ios-xcframework/
          done < "$XCF_LIST_FILE"

          ditto -c -k --sequesterRsrc --keepParent artifacts/ios-xcframework ffmpegkit-ios-xcframework.zip

      - name: Generate Release Metadata
        id: release_meta
        run: |
          set -euo pipefail
          TAG="ios"
          NAME="iOS FFmpeg Kit Custom"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"

      - name: Publish to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.RELEASE_TOKEN != '' && secrets.RELEASE_TOKEN || github.token }}
          tag_name: ${{ steps.release_meta.outputs.tag }}
          name: ${{ steps.release_meta.outputs.name }}
          target_commitish: ${{ github.sha }}
          prerelease: true
          generate_release_notes: true
          overwrite_files: true
          files: |
            ffmpegkit-ios-xcframework.zip
            build.log

      - name: Print Build Logs on Failure
        if: failure()
        run: |
          echo "=== Build Log (tail 500) ==="
          [ -f build.log ] && tail -n 500 build.log
          echo "=== config.log tail ==="
          find . -name "config.log" -exec sh -c 'echo "--- $1 ---"; tail -n 200 "$1"' _ {} \;

      - name: Upload iOS Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-kit-ios-custom
          if-no-files-found: error
          path: |
            ffmpegkit-ios-xcframework.zip
            build.log
