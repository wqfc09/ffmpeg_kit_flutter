name: FFmpeg-LGPL3-General

permissions:
  contents: write

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/LGPL3-desktop-ffmpeg.yml"
      - ".github/workflows/LGPL3-mobile-ffmpeg.yml"
      - ".github/workflows/LGPL3-android-ffmpeg.yml"
      - ".github/workflows/LGPL3-xframework-ffmpeg.yml"
      - ".github/workflows/LGPL3-general-ffmpeg.yml"

jobs:
  run-mobile:
    name: Run Mobile Workflow
    uses: ./.github/workflows/LGPL3-mobile-ffmpeg.yml
    secrets: inherit

  run-desktop:
    name: Run Desktop Workflow
    uses: ./.github/workflows/LGPL3-desktop-ffmpeg.yml
    secrets: inherit

  publish-general:
    name: Publish General Release
    needs: [run-mobile, run-desktop]
    runs-on: ubuntu-24.04
    steps:
      - name: Download Android Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ffmpeg-kit-android-custom
          merge-multiple: true
          path: release-assets/android

      - name: Download iOS Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ffmpeg-kit-ios-custom
          merge-multiple: true
          path: release-assets/ios

      - name: Download Desktop Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-desktop-*
          merge-multiple: true
          path: release-assets/desktop

      - name: Check Release Assets
        run: |
          set -euo pipefail
          find release-assets -maxdepth 3 -type f | sort
          test -f release-assets/desktop/ffmpeg-desktop-windows-n8.0.1.tar.gz
          test -f release-assets/desktop/ffmpeg-desktop-macos-n8.0.1.tar.gz
          test -f release-assets/desktop/ffmpeg-desktop-linux-n8.0.1.tar.gz
          test -f release-assets/android/ffmpegkit-android-aar.tar.gz
          test -f release-assets/android/android-build.log
          test -f release-assets/ios/ffmpegkit-ios-xcframework.zip
          test -f release-assets/ios/ios-build.log

      - name: Generate All Release Metadata
        id: release_meta
        run: |
          set -euo pipefail
          SHORT_SHA="${GITHUB_SHA::8}"
          TAG="all-${SHORT_SHA}"
          NAME="All FFmpeg (${SHORT_SHA})"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"

      - name: Upload General Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-general-files
          if-no-files-found: error
          path: |
            release-assets/desktop/ffmpeg-desktop-windows-n8.0.1.tar.gz
            release-assets/desktop/ffmpeg-desktop-macos-n8.0.1.tar.gz
            release-assets/desktop/ffmpeg-desktop-linux-n8.0.1.tar.gz
            release-assets/android/ffmpegkit-android-aar.tar.gz
            release-assets/android/android-build.log
            release-assets/ios/ffmpegkit-ios-xcframework.zip
            release-assets/ios/ios-build.log

      - name: Publish to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.RELEASE_TOKEN != '' && secrets.RELEASE_TOKEN || github.token }}
          tag_name: ${{ steps.release_meta.outputs.tag }}
          name: ${{ steps.release_meta.outputs.name }}
          target_commitish: ${{ github.sha }}
          prerelease: true
          generate_release_notes: true
          overwrite_files: false
          files: |
            release-assets/desktop/ffmpeg-desktop-windows-n8.0.1.tar.gz
            release-assets/desktop/ffmpeg-desktop-macos-n8.0.1.tar.gz
            release-assets/desktop/ffmpeg-desktop-linux-n8.0.1.tar.gz
            release-assets/android/ffmpegkit-android-aar.tar.gz
            release-assets/android/android-build.log
            release-assets/ios/ffmpegkit-ios-xcframework.zip
            release-assets/ios/ios-build.log
